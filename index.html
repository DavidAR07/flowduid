<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracker Keuangan Multi-Dompet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase configuration - GANTI DENGAN KONFIGURASI ANDA
        const firebaseConfig = {
    apiKey: "AIzaSyASOFW-kGHoHemOJ80gax4CVKU03wDJyA8",
    authDomain: "flow-duid.firebaseapp.com",
    databaseURL: "https://flow-duid-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "flow-duid",
    storageBucket: "flow-duid.firebasestorage.app",
    messagingSenderId: "955684305421",
    appId: "1:955684305421:web:c5a9df43211e097836f344",
    measurementId: "G-LN1V1G5MLJ"
  };

        try {
            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            
            // Make Firebase available globally
            window.db = db;
            window.firestore = { collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, query, orderBy };
            window.firebaseReady = true;
            
            console.log('âœ… Firebase initialized successfully');
        } catch (error) {
            console.log('âŒ Firebase initialization failed:', error);
            window.firebaseReady = false;
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .slide-up { animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .chart-bar { transition: all 0.3s ease; cursor: pointer; }
        .chart-bar:hover { opacity: 0.8; transform: scaleY(1.05); }
        .firebase-status { position: fixed; top: 10px; right: 10px; z-index: 1000; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Firebase Status Indicator -->
    <div id="firebaseStatus" class="firebase-status px-3 py-1 rounded-full text-xs font-medium">
        ğŸ”„ Menghubungkan...
    </div>

    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Header -->
        <div class="text-center mb-6 slide-up">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ’° Tracker Keuangan Multi-Dompet</h1>
            <p class="text-gray-600">Kelola keuangan David, Fitri, dan Usaha dengan sistem hutang-piutang</p>
        </div>

        <!-- Wallet Selection -->
        <div class="bg-white rounded-xl shadow-lg p-4 mb-6 fade-in">
            <h2 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                <span class="mr-2">ğŸ‘›</span> Pilih Dompet Aktif
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <button onclick="switchWallet('david')" id="wallet-david" class="wallet-btn p-3 border-2 border-blue-300 rounded-lg hover:bg-blue-50 transition-all">
                    <div class="text-center">
                        <div class="text-2xl mb-1">ğŸ‘¨â€ğŸ’¼</div>
                        <h3 class="font-semibold text-gray-800 text-sm">David</h3>
                        <p class="text-xs text-gray-600" id="david-balance">Rp 0</p>
                    </div>
                </button>
                <button onclick="switchWallet('fitri')" id="wallet-fitri" class="wallet-btn p-3 border-2 border-pink-300 rounded-lg hover:bg-pink-50 transition-all">
                    <div class="text-center">
                        <div class="text-2xl mb-1">ğŸ‘©â€ğŸ’¼</div>
                        <h3 class="font-semibold text-gray-800 text-sm">Fitri</h3>
                        <p class="text-xs text-gray-600" id="fitri-balance">Rp 0</p>
                    </div>
                </button>
                <button onclick="switchWallet('usaha')" id="wallet-usaha" class="wallet-btn p-3 border-2 border-green-300 rounded-lg hover:bg-green-50 transition-all">
                    <div class="text-center">
                        <div class="text-2xl mb-1">ğŸ¢</div>
                        <h3 class="font-semibold text-gray-800 text-sm">Usaha</h3>
                        <p class="text-xs text-gray-600" id="usaha-balance">Rp 0</p>
                    </div>
                </button>
            </div>
        </div>

        <!-- Current Wallet Info -->
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-xl shadow-lg p-4 mb-6 fade-in">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-bold" id="current-wallet-name">Pilih Dompet</h2>
                    <p class="text-purple-100 text-sm">Dompet aktif saat ini</p>
                </div>
                <div class="text-right">
                    <p class="text-xs text-purple-100">Saldo</p>
                    <p class="text-2xl font-bold" id="current-wallet-balance">Rp 0</p>
                </div>
            </div>
        </div>

        <!-- Main Layout -->
        <div class="grid grid-cols-1 xl:grid-cols-4 gap-6">
            <!-- Sidebar - Form & Quick Actions -->
            <div class="xl:col-span-1">
                <!-- Transaction Form -->
                <div class="bg-white rounded-xl shadow-lg p-4 mb-4 fade-in sticky top-4">
                    <h2 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                        <span class="mr-2">â•</span> Tambah Transaksi
                    </h2>
                    
                    <form id="transactionForm" class="space-y-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Jenis Transaksi</label>
                            <select id="type" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="income">ğŸ’° Pemasukan</option>
                                <option value="expense">ğŸ’¸ Pengeluaran</option>
                                <option value="debt">ğŸ”´ Hutang (Pinjam dari...)</option>
                                <option value="credit">ğŸŸ¢ Piutang (Pinjamkan ke...)</option>
                                <option value="debt-payment">ğŸ’³ Bayar Hutang</option>
                                <option value="credit-payment">ğŸ’° Terima Pembayaran</option>
                            </select>
                        </div>

                        <div id="wallet-selector" class="hidden">
                            <label class="block text-xs font-medium text-gray-700 mb-1">Dari/Ke Dompet</label>
                            <select id="target-wallet" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="david">ğŸ‘¨â€ğŸ’¼ David</option>
                                <option value="fitri">ğŸ‘©â€ğŸ’¼ Fitri</option>
                                <option value="usaha">ğŸ¢ Usaha</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Jumlah (Rp)</label>
                            <input type="text" id="amount" placeholder="0" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                        </div>

                        <div id="category-section">
                            <label class="block text-xs font-medium text-gray-700 mb-1">Kategori</label>
                            <select id="category" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="penjualan">ğŸ›’ Penjualan</option>
                                <option value="investasi">ğŸ“ˆ Investasi</option>
                                <option value="lainnya-masuk">ğŸ’¼ Lainnya</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Keterangan</label>
                            <input type="text" id="description" placeholder="Deskripsi transaksi..." class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                        </div>

                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Tanggal</label>
                            <input type="date" id="date" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                        </div>

                        <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-2 px-4 rounded-lg font-medium hover:from-blue-700 hover:to-purple-700 transform hover:scale-105 transition-all duration-200 shadow-lg text-sm">
                            âœ¨ Tambah Transaksi
                        </button>
                    </form>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white rounded-xl shadow-lg p-4 fade-in">
                    <h3 class="text-sm font-semibold text-gray-800 mb-3">ğŸš€ Aksi Cepat</h3>
                    <div class="space-y-2">
                        <button onclick="showDebtReport()" class="w-full bg-orange-600 text-white py-2 px-3 rounded-lg hover:bg-orange-700 transition-colors text-xs">
                            ğŸ“‹ Laporan Hutang-Piutang
                        </button>
                        <button onclick="exportData()" class="w-full bg-green-600 text-white py-2 px-3 rounded-lg hover:bg-green-700 transition-colors text-xs">
                            ğŸ“Š Export Data
                        </button>
                        <button onclick="syncNow()" class="w-full bg-blue-600 text-white py-2 px-3 rounded-lg hover:bg-blue-700 transition-colors text-xs">
                            ğŸ”„ Sync Manual
                        </button>
                        <button onclick="clearAllData()" class="w-full bg-red-600 text-white py-2 px-3 rounded-lg hover:bg-red-700 transition-colors text-xs">
                            ğŸ—‘ï¸ Hapus Semua Data
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="xl:col-span-3 space-y-6">
                <!-- Debt Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white rounded-xl shadow-lg p-4 border-l-4 border-red-500 slide-up">
                        <h3 class="text-sm font-semibold text-gray-800 mb-2">ğŸ”´ Hutang Aktif</h3>
                        <div id="debt-summary" class="space-y-1">
                            <p class="text-gray-500 text-xs">Tidak ada hutang</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-4 border-l-4 border-green-500 slide-up">
                        <h3 class="text-sm font-semibold text-gray-800 mb-2">ğŸŸ¢ Piutang Aktif</h3>
                        <div id="credit-summary" class="space-y-1">
                            <p class="text-gray-500 text-xs">Tidak ada piutang</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-4 border-l-4 border-blue-500 slide-up">
                        <h3 class="text-sm font-semibold text-gray-800 mb-2">ğŸ“Š Total Transaksi</h3>
                        <p class="text-2xl font-bold text-blue-600" id="total-transactions">0</p>
                    </div>
                </div>

                <!-- Daily Chart Section -->
                <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                            <span class="mr-2">ğŸ“Š</span> Grafik Harian
                        </h3>
                        <div class="flex items-center space-x-3">
                            <!-- Month Navigation -->
                            <div class="flex items-center space-x-2 bg-gray-100 rounded-lg p-1">
                                <button onclick="changeChartMonth(-1)" class="px-3 py-2 text-sm bg-white rounded hover:bg-gray-50 transition-colors shadow-sm">
                                    â† Bulan Lalu
                                </button>
                                <span id="chartMonthDisplay" class="px-4 py-2 text-sm font-medium text-gray-700 min-w-[140px] text-center bg-white rounded shadow-sm">
                                    Loading...
                                </span>
                                <button onclick="changeChartMonth(1)" class="px-3 py-2 text-sm bg-white rounded hover:bg-gray-50 transition-colors shadow-sm">
                                    Bulan Depan â†’
                                </button>
                            </div>
                            <select id="chartWalletFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="all">Semua Dompet</option>
                                <option value="david">ğŸ‘¨â€ğŸ’¼ David</option>
                                <option value="fitri">ğŸ‘©â€ğŸ’¼ Fitri</option>
                                <option value="usaha">ğŸ¢ Usaha</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Current Month Summary -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="text-sm font-semibold text-blue-800">Bulan Dipilih</h4>
                            <p class="text-lg font-bold text-blue-600" id="currentMonthName">-</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="text-sm font-semibold text-green-800">Total Pemasukan</h4>
                            <p class="text-lg font-bold text-green-600" id="currentMonthIncome">Rp 0</p>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg">
                            <h4 class="text-sm font-semibold text-red-800">Total Pengeluaran</h4>
                            <p class="text-lg font-bold text-red-600" id="currentMonthExpense">Rp 0</p>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h4 class="text-sm font-semibold text-purple-800">Saldo Bersih</h4>
                            <p class="text-lg font-bold text-purple-600" id="currentMonthNet">Rp 0</p>
                        </div>
                    </div>

                    <!-- Chart -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <!-- Chart Container with Scroll -->
                        <div id="dailyChartContainer" class="relative">
                            <div id="dailyChart" class="h-64 overflow-x-auto">
                                <div class="flex items-end justify-start bg-gray-50 rounded-lg p-2 relative min-w-full">
                                    <div class="absolute inset-0 flex items-center justify-center text-center text-gray-500">
                                        <div>
                                            <span class="text-4xl mb-2 block">ğŸ“ˆ</span>
                                            <p>Grafik akan muncul setelah ada data transaksi</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Chart Controls -->
                        <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-200">
                            <div class="flex items-center space-x-4">
                                <div class="flex items-center space-x-2 text-xs">
                                    <div class="w-3 h-3 bg-green-500 rounded"></div>
                                    <span>Pemasukan</span>
                                </div>
                                <div class="flex items-center space-x-2 text-xs">
                                    <div class="w-3 h-3 bg-red-500 rounded"></div>
                                    <span>Pengeluaran</span>
                                </div>
                                <div class="flex items-center space-x-2 text-xs">
                                    <div class="w-3 h-3 bg-blue-500 rounded"></div>
                                    <span>Saldo Harian</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="scrollChart('left')" class="px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-xs">
                                    â† Scroll
                                </button>
                                <button onclick="scrollChart('right')" class="px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-xs">
                                    Scroll â†’
                                </button>
                                <button onclick="scrollToToday()" class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-xs">
                                    Hari Ini
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Top Categories -->
                    <div>
                        <h4 class="text-sm font-semibold text-gray-800 mb-3">ğŸ† Top 3 Kategori Pengeluaran Bulan Dipilih</h4>
                        <div id="topCategories" class="space-y-2">
                            <p class="text-gray-500 text-sm">Belum ada data pengeluaran</p>
                        </div>
                    </div>
                </div>

                <!-- Transaction List -->
                <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold text-gray-800 flex items-center">
                            <span class="mr-2">ğŸ“‹</span> Riwayat Transaksi
                        </h2>
                        <div class="flex space-x-2">
                            <select id="filterType" class="px-2 py-1 border border-gray-300 rounded text-xs">
                                <option value="all">Semua</option>
                                <option value="income">Pemasukan</option>
                                <option value="expense">Pengeluaran</option>
                                <option value="debt">Hutang</option>
                                <option value="credit">Piutang</option>
                            </select>
                            <select id="filterWallet" class="px-2 py-1 border border-gray-300 rounded text-xs">
                                <option value="all">Semua Dompet</option>
                                <option value="david">David</option>
                                <option value="fitri">Fitri</option>
                                <option value="usaha">Usaha</option>
                            </select>
                            <select id="filterPeriod" class="px-2 py-1 border border-gray-300 rounded text-xs">
                                <option value="all">Semua Periode</option>
                                <option value="today">Hari Ini</option>
                                <option value="week">Minggu Ini</option>
                                <option value="month">Bulan Ini</option>
                            </select>
                        </div>
                    </div>

                    <div id="transactionList" class="space-y-2 max-h-80 overflow-y-auto">
                        <div class="text-center text-gray-500 py-8">
                            <span class="text-4xl mb-4 block">ğŸ“</span>
                            <p>Pilih dompet dan tambahkan transaksi pertama!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Debt Report -->
    <div id="reportModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 m-4 max-w-4xl w-full max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">ğŸ“Š Laporan Hutang-Piutang</h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="reportContent"></div>
        </div>
    </div>

    <script>
        let transactions = [];
        let debts = []; // Track active debts
        let currentWallet = null;
        let editingId = null;
        let isFirebaseReady = false;
        let currentChartMonth = new Date(); // Current month being displayed in chart
        let unsubscribeTransactions = null;
        let unsubscribeDebts = null;

        // Wallet data
        const wallets = {
            david: { name: 'David', icon: 'ğŸ‘¨â€ğŸ’¼', color: 'blue' },
            fitri: { name: 'Fitri', icon: 'ğŸ‘©â€ğŸ’¼', color: 'pink' },
            usaha: { name: 'Usaha', icon: 'ğŸ¢', color: 'green' }
        };

        // Set today's date as default
        document.getElementById('date').valueAsDate = new Date();

        // Format number input with thousand separators
        document.getElementById('amount').addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^\d]/g, ''); // Remove non-digits
            if (value) {
                // Add thousand separators
                value = parseInt(value).toLocaleString('id-ID');
            }
            e.target.value = value;
        });

        // Transaction type change handler
        document.getElementById('type').addEventListener('change', function() {
            const type = this.value;
            const walletSelector = document.getElementById('wallet-selector');
            const categorySection = document.getElementById('category-section');
            const targetWallet = document.getElementById('target-wallet');
            
            // Show/hide wallet selector for debt/credit transactions
            if (['debt', 'credit', 'debt-payment', 'credit-payment'].includes(type)) {
                walletSelector.classList.remove('hidden');
                categorySection.classList.add('hidden');
                
                // Update target wallet options (exclude current wallet)
                updateTargetWalletOptions();
            } else {
                walletSelector.classList.add('hidden');
                categorySection.classList.remove('hidden');
                updateCategoryOptions();
            }
        });

        function updateTargetWalletOptions() {
            const targetWallet = document.getElementById('target-wallet');
            targetWallet.innerHTML = '';
            
            Object.keys(wallets).forEach(walletId => {
                if (walletId !== currentWallet) {
                    const wallet = wallets[walletId];
                    targetWallet.innerHTML += `<option value="${walletId}">${wallet.icon} ${wallet.name}</option>`;
                }
            });
        }

        function updateCategoryOptions() {
            const type = document.getElementById('type').value;
            const categorySelect = document.getElementById('category');
            
            if (type === 'income') {
                categorySelect.innerHTML = `
                    <option value="penjualan">ğŸ›’ Penjualan</option>
                    <option value="investasi">ğŸ“ˆ Investasi</option>
                    <option value="lainnya-masuk">ğŸ’¼ Lainnya</option>
                `;
            } else {
                categorySelect.innerHTML = `
                    <option value="bahan-baku">ğŸ“¦ Bahan Baku</option>
                    <option value="operasional">âš™ï¸ Operasional</option>
                    <option value="marketing">ğŸ“¢ Marketing</option>
                    <option value="sewa">ğŸ¢ Sewa</option>
                    <option value="tabungan">ğŸ’° Tabungan</option>
                    <option value="lainnya-keluar">ğŸ“‹ Lainnya</option>
                `;
            }
        }

        function switchWallet(walletId) {
            currentWallet = walletId;
            
            // Update active wallet styling
            document.querySelectorAll('.wallet-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'border-pink-500', 'border-green-500', 'bg-blue-100', 'bg-pink-100', 'bg-green-100');
                btn.classList.add(`border-${wallets[walletId].color}-300`);
            });
            
            const activeBtn = document.getElementById(`wallet-${walletId}`);
            activeBtn.classList.remove(`border-${wallets[walletId].color}-300`);
            activeBtn.classList.add(`border-${wallets[walletId].color}-500`, `bg-${wallets[walletId].color}-100`);
            
            // Update current wallet display
            document.getElementById('current-wallet-name').textContent = `${wallets[walletId].icon} ${wallets[walletId].name}`;
            
            updateWalletBalances();
            displayTransactions();
            updateTargetWalletOptions();
            updateDailyChart();
            updateCurrentMonthSummary();
        }

        // Initialize Firebase real-time listeners
        function initializeFirebase() {
            // Wait for Firebase to be ready
            const checkFirebase = () => {
                if (window.firebaseReady && window.db) {
                    setupFirebaseListeners();
                } else if (window.firebaseReady === false) {
                    // Firebase failed to initialize
                    updateFirebaseStatus('offline');
                    loadLocalData();
                } else {
                    // Still waiting
                    setTimeout(checkFirebase, 100);
                }
            };
            checkFirebase();
        }

        function setupFirebaseListeners() {
            try {
                updateFirebaseStatus('connecting');
                
                // Listen to transactions collection
                const transactionsQuery = window.firestore.query(
                    window.firestore.collection(window.db, 'transactions'),
                    window.firestore.orderBy('timestamp', 'desc')
                );
                
                unsubscribeTransactions = window.firestore.onSnapshot(transactionsQuery, (snapshot) => {
                    transactions = [];
                    snapshot.forEach((doc) => {
                        transactions.push({ firebaseId: doc.id, ...doc.data() });
                    });
                    updateWalletBalances();
                    displayTransactions();
                    updateDailyChart();
                    updateCurrentMonthSummary();
                    isFirebaseReady = true;
                    updateFirebaseStatus('online');
                }, (error) => {
                    console.log('Firebase transactions error:', error);
                    updateFirebaseStatus('error');
                    loadLocalData(); // Fallback to local storage
                });

                // Listen to debts collection
                const debtsQuery = window.firestore.query(
                    window.firestore.collection(window.db, 'debts'),
                    window.firestore.orderBy('date', 'desc')
                );
                
                unsubscribeDebts = window.firestore.onSnapshot(debtsQuery, (snapshot) => {
                    debts = [];
                    snapshot.forEach((doc) => {
                        debts.push({ firebaseId: doc.id, ...doc.data() });
                    });
                    updateDebtSummary();
                }, (error) => {
                    console.log('Firebase debts error:', error);
                    // Load local debts as fallback
                    debts = JSON.parse(localStorage.getItem('debts')) || [];
                    updateDebtSummary();
                });

            } catch (error) {
                console.log('Firebase setup error:', error);
                updateFirebaseStatus('error');
                loadLocalData(); // Fallback to local storage
            }
        }

        function updateFirebaseStatus(status) {
            const statusElement = document.getElementById('firebaseStatus');
            
            switch (status) {
                case 'connecting':
                    statusElement.textContent = 'ğŸ”„ Menghubungkan...';
                    statusElement.className = 'firebase-status px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800';
                    break;
                case 'online':
                    statusElement.textContent = 'âœ… Tersinkron';
                    statusElement.className = 'firebase-status px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800';
                    break;
                case 'offline':
                    statusElement.textContent = 'ğŸ“± Mode Offline';
                    statusElement.className = 'firebase-status px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800';
                    break;
                case 'error':
                    statusElement.textContent = 'âš ï¸ Error Sync';
                    statusElement.className = 'firebase-status px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800';
                    break;
            }
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateCategoryOptions();
            initializeFirebase();
            // Default to David's wallet
            switchWallet('david');
        });

        function loadLocalData() {
            transactions = JSON.parse(localStorage.getItem('transactions')) || [];
            debts = JSON.parse(localStorage.getItem('debts')) || [];
            updateWalletBalances();
            updateDebtSummary();
            displayTransactions();
            updateDailyChart();
            updateCurrentMonthSummary();
        }

        function saveLocalData() {
            localStorage.setItem('transactions', JSON.stringify(transactions));
            localStorage.setItem('debts', JSON.stringify(debts));
        }

        // Save to Firebase
        async function saveToFirebase(transaction, debtData = null) {
            if (!isFirebaseReady || !window.db) {
                saveLocalData();
                return;
            }

            try {
                // Save transaction to Firebase
                const docRef = await window.firestore.addDoc(
                    window.firestore.collection(window.db, 'transactions'), 
                    transaction
                );

                // Save debt data if exists
                if (debtData) {
                    await window.firestore.addDoc(
                        window.firestore.collection(window.db, 'debts'), 
                        debtData
                    );
                }

                // Also save to local storage as backup
                saveLocalData();
                
                showNotification('âœ… Data tersimpan dan tersinkron!', 'success');
                
            } catch (error) {
                console.log('Firebase save error:', error);
                // Fallback to local storage
                saveLocalData();
                showNotification('âš ï¸ Tersimpan lokal - akan sync otomatis', 'info');
            }
        }

        // Delete from Firebase
        async function deleteFromFirebase(firebaseId) {
            if (!isFirebaseReady || !window.db || !firebaseId) return;

            try {
                await window.firestore.deleteDoc(
                    window.firestore.doc(window.db, 'transactions', firebaseId)
                );
            } catch (error) {
                console.log('Firebase delete error:', error);
            }
        }

        // Manual sync function
        async function syncNow() {
            if (!window.db) {
                showNotification('âŒ Firebase tidak tersedia', 'error');
                return;
            }

            showNotification('ğŸ”„ Memulai sinkronisasi...', 'info');
            
            try {
                // Re-initialize Firebase listeners
                if (unsubscribeTransactions) unsubscribeTransactions();
                if (unsubscribeDebts) unsubscribeDebts();
                
                setupFirebaseListeners();
                showNotification('âœ… Sinkronisasi berhasil!', 'success');
            } catch (error) {
                showNotification('âŒ Gagal sinkronisasi', 'error');
            }
        }

        // Form submission
        document.getElementById('transactionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentWallet) {
                showNotification('Pilih dompet terlebih dahulu!', 'error');
                return;
            }
            
            const type = document.getElementById('type').value;
            const amountStr = document.getElementById('amount').value.replace(/[^\d]/g, '');
            const amount = parseFloat(amountStr);
            const description = document.getElementById('description').value;
            const date = document.getElementById('date').value;
            
            let category = null;
            let targetWallet = null;
            
            if (['debt', 'credit', 'debt-payment', 'credit-payment'].includes(type)) {
                targetWallet = document.getElementById('target-wallet').value;
            } else {
                category = document.getElementById('category').value;
            }

            const transaction = {
                id: Date.now(),
                wallet: currentWallet,
                type,
                amount,
                category,
                targetWallet,
                description,
                date,
                timestamp: new Date().toISOString()
            };

            let debtData = null;

            // Handle debt/credit logic
            if (type === 'debt') {
                // Create debt record
                debtData = {
                    id: Date.now(),
                    from: targetWallet,
                    to: currentWallet,
                    amount: amount,
                    description: description,
                    date: date,
                    status: 'active'
                };
                debts.push(debtData);
            } else if (type === 'credit') {
                // Create credit record (reverse debt)
                debtData = {
                    id: Date.now(),
                    from: currentWallet,
                    to: targetWallet,
                    amount: amount,
                    description: description,
                    date: date,
                    status: 'active'
                };
                debts.push(debtData);
            } else if (type === 'debt-payment') {
                // Find and reduce/remove debt
                const debtIndex = debts.findIndex(d => 
                    d.to === currentWallet && 
                    d.from === targetWallet && 
                    d.status === 'active'
                );
                if (debtIndex !== -1) {
                    if (debts[debtIndex].amount <= amount) {
                        debts[debtIndex].status = 'paid';
                    } else {
                        debts[debtIndex].amount -= amount;
                    }
                }
            } else if (type === 'credit-payment') {
                // Find and reduce/remove credit
                const debtIndex = debts.findIndex(d => 
                    d.from === currentWallet && 
                    d.to === targetWallet && 
                    d.status === 'active'
                );
                if (debtIndex !== -1) {
                    if (debts[debtIndex].amount <= amount) {
                        debts[debtIndex].status = 'paid';
                    } else {
                        debts[debtIndex].amount -= amount;
                    }
                }
            }

            // Add to local array first for immediate UI update
            transactions.unshift(transaction);
            
            // Save to Firebase (will also save to local storage)
            await saveToFirebase(transaction, debtData);
            
            // Reset form
            this.reset();
            document.getElementById('date').valueAsDate = new Date();
            updateCategoryOptions();
            
            updateWalletBalances();
            displayTransactions();
            updateDebtSummary();
            updateDailyChart();
            updateCurrentMonthSummary();
        });

        function updateWalletBalances() {
            Object.keys(wallets).forEach(walletId => {
                let balance = 0;
                
                transactions.forEach(t => {
                    if (t.wallet === walletId) {
                        if (t.type === 'income' || t.type === 'debt' || t.type === 'credit-payment') {
                            balance += t.amount;
                        } else if (t.type === 'expense' || t.type === 'credit' || t.type === 'debt-payment') {
                            balance -= t.amount;
                        }
                    }
                });
                
                document.getElementById(`${walletId}-balance`).textContent = formatCurrency(balance);
                
                if (walletId === currentWallet) {
                    document.getElementById('current-wallet-balance').textContent = formatCurrency(balance);
                }
            });
            
            // Update total transactions
            document.getElementById('total-transactions').textContent = transactions.length;
        }

        function updateDebtSummary() {
            const activeDebts = debts.filter(d => d.status === 'active');
            
            // Current wallet's debts (what current wallet owes)
            const currentWalletDebts = activeDebts.filter(d => d.to === currentWallet);
            const debtSummary = document.getElementById('debt-summary');
            
            if (currentWalletDebts.length === 0) {
                debtSummary.innerHTML = '<p class="text-gray-500 text-xs">Tidak ada hutang</p>';
            } else {
                debtSummary.innerHTML = currentWalletDebts.map(debt => `
                    <div class="flex justify-between items-center text-xs">
                        <span>ke ${wallets[debt.from].icon} ${wallets[debt.from].name}</span>
                        <span class="font-medium text-red-600">${formatCurrency(debt.amount)}</span>
                    </div>
                `).join('');
            }
            
            // Current wallet's credits (what others owe to current wallet)
            const currentWalletCredits = activeDebts.filter(d => d.from === currentWallet);
            const creditSummary = document.getElementById('credit-summary');
            
            if (currentWalletCredits.length === 0) {
                creditSummary.innerHTML = '<p class="text-gray-500 text-xs">Tidak ada piutang</p>';
            } else {
                creditSummary.innerHTML = currentWalletCredits.map(debt => `
                    <div class="flex justify-between items-center text-xs">
                        <span>dari ${wallets[debt.to].icon} ${wallets[debt.to].name}</span>
                        <span class="font-medium text-green-600">${formatCurrency(debt.amount)}</span>
                    </div>
                `).join('');
            }
        }

        function changeChartMonth(direction) {
            currentChartMonth.setMonth(currentChartMonth.getMonth() + direction);
            updateDailyChart();
            updateCurrentMonthSummary();
        }

        function updateDailyChart() {
            const chartElement = document.getElementById('dailyChart');
            const walletFilter = document.getElementById('chartWalletFilter').value;
            
            // Update month display
            const monthDisplay = document.getElementById('chartMonthDisplay');
            monthDisplay.textContent = currentChartMonth.toLocaleDateString('id-ID', { 
                month: 'long', 
                year: 'numeric' 
            });
            
            // Filter transactions by wallet if needed
            let filteredTransactions = transactions;
            if (walletFilter !== 'all') {
                filteredTransactions = transactions.filter(t => t.wallet === walletFilter);
            }
            
            // Get current month string (YYYY-MM)
            const currentMonthStr = `${currentChartMonth.getFullYear()}-${String(currentChartMonth.getMonth() + 1).padStart(2, '0')}`;
            
            // Filter transactions for current month
            const monthTransactions = filteredTransactions.filter(t => 
                t.date.substring(0, 7) === currentMonthStr
            );
            
            if (monthTransactions.length === 0) {
                chartElement.innerHTML = `
                    <div class="flex items-end justify-start bg-gray-50 rounded-lg p-2 relative min-w-full h-64">
                        <div class="absolute inset-0 flex items-center justify-center text-center text-gray-500">
                            <div>
                                <span class="text-4xl mb-2 block">ğŸ“ˆ</span>
                                <p>Tidak ada transaksi di bulan ini</p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            // Get days in current month
            const year = currentChartMonth.getFullYear();
            const month = currentChartMonth.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Group transactions by day
            const dailyData = {};
            for (let day = 1; day <= daysInMonth; day++) {
                const dayStr = `${currentMonthStr}-${String(day).padStart(2, '0')}`;
                dailyData[dayStr] = { income: 0, expense: 0, transactions: [] };
            }
            
            monthTransactions.forEach(t => {
                if (dailyData[t.date]) {
                    dailyData[t.date].transactions.push(t);
                    if (t.type === 'income' || t.type === 'debt' || t.type === 'credit-payment') {
                        dailyData[t.date].income += t.amount;
                    } else if (t.type === 'expense' || t.type === 'credit' || t.type === 'debt-payment') {
                        dailyData[t.date].expense += t.amount;
                    }
                }
            });

            // Calculate max amount for scaling
            const maxAmount = Math.max(...Object.values(dailyData).map(d => Math.max(d.income, d.expense, Math.abs(d.income - d.expense))));
            
            // Calculate running balance
            let runningBalance = 0;
            const today = new Date().toISOString().split('T')[0];
            
            const chartContent = Object.keys(dailyData).map(dateStr => {
                const data = dailyData[dateStr];
                const dayBalance = data.income - data.expense;
                runningBalance += dayBalance;
                
                const incomeHeight = maxAmount > 0 ? Math.max((data.income / maxAmount) * 180, data.income > 0 ? 4 : 0) : 0;
                const expenseHeight = maxAmount > 0 ? Math.max((data.expense / maxAmount) * 180, data.expense > 0 ? 4 : 0) : 0;
                const balanceHeight = maxAmount > 0 ? Math.abs(dayBalance / maxAmount) * 60 : 0;
                
                const day = parseInt(dateStr.split('-')[2]);
                const isToday = dateStr === today;
                const hasTransactions = data.transactions.length > 0;
                
                return `
                    <div class="flex flex-col items-center space-y-1 min-w-[32px] px-1 group cursor-pointer" 
                         onclick="showDayDetails('${dateStr}')"
                         title="Klik untuk detail transaksi ${day}/${month + 1}">
                        
                        <!-- Balance indicator (top) -->
                        <div class="w-full flex justify-center">
                            <div class="w-2 ${dayBalance > 0 ? 'bg-blue-500' : dayBalance < 0 ? 'bg-orange-500' : 'bg-gray-300'} rounded-full transition-all group-hover:w-3" 
                                 style="height: ${Math.max(balanceHeight, 2)}px;"
                                 title="Saldo harian: ${formatCurrency(dayBalance)}"></div>
                        </div>
                        
                        <!-- Income/Expense bars -->
                        <div class="flex items-end space-x-1 justify-center w-full">
                            <div class="chart-bar bg-green-500 rounded-t transition-all group-hover:bg-green-600 min-w-[6px] max-w-[12px] flex-1" 
                                 style="height: ${incomeHeight}px;" 
                                 title="Pemasukan: ${formatCurrency(data.income)}"></div>
                            <div class="chart-bar bg-red-500 rounded-t transition-all group-hover:bg-red-600 min-w-[6px] max-w-[12px] flex-1" 
                                 style="height: ${expenseHeight}px;" 
                                 title="Pengeluaran: ${formatCurrency(data.expense)}"></div>
                        </div>
                        
                        <!-- Day number -->
                        <div class="text-center">
                            <span class="text-xs ${isToday ? 'font-bold text-blue-600 bg-blue-100 px-1 rounded' : hasTransactions ? 'font-medium text-gray-800' : 'text-gray-400'} transition-colors group-hover:text-blue-600">
                                ${day}
                            </span>
                            ${hasTransactions ? `<div class="w-1 h-1 bg-blue-500 rounded-full mx-auto mt-1"></div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            chartElement.innerHTML = `
                <div class="flex items-end justify-start bg-gray-50 rounded-lg p-2 relative h-64" style="min-width: ${daysInMonth * 40}px;">
                    <div class="flex items-end space-x-1 w-full">
                        ${chartContent}
                    </div>
                </div>
            `;
        }

        function scrollChart(direction) {
            const chartContainer = document.getElementById('dailyChart');
            const scrollAmount = 200;
            
            if (direction === 'left') {
                chartContainer.scrollLeft -= scrollAmount;
            } else {
                chartContainer.scrollLeft += scrollAmount;
            }
        }

        function scrollToToday() {
            const today = new Date();
            const todayDay = today.getDate();
            
            // Check if current chart month is the same as today's month
            if (currentChartMonth.getMonth() === today.getMonth() && 
                currentChartMonth.getFullYear() === today.getFullYear()) {
                
                const chartContainer = document.getElementById('dailyChart');
                const dayWidth = 40; // Approximate width per day
                const scrollPosition = (todayDay - 1) * dayWidth - (chartContainer.clientWidth / 2);
                
                chartContainer.scrollTo({
                    left: Math.max(0, scrollPosition),
                    behavior: 'smooth'
                });
            } else {
                // Switch to current month first
                currentChartMonth = new Date();
                updateDailyChart();
                updateCurrentMonthSummary();
                
                // Then scroll to today
                setTimeout(() => scrollToToday(), 100);
            }
        }

        function showDayDetails(dateStr) {
            const walletFilter = document.getElementById('chartWalletFilter').value;
            
            let filteredTransactions = transactions;
            if (walletFilter !== 'all') {
                filteredTransactions = filteredTransactions.filter(t => t.wallet === walletFilter);
            }
            
            const dayTransactions = filteredTransactions.filter(t => t.date === dateStr);
            
            if (dayTransactions.length === 0) {
                showNotification(`Tidak ada transaksi pada ${formatDate(dateStr)}`, 'info');
                return;
            }
            
            const dayIncome = dayTransactions
                .filter(t => t.type === 'income' || t.type === 'debt' || t.type === 'credit-payment')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const dayExpense = dayTransactions
                .filter(t => t.type === 'expense' || t.type === 'credit' || t.type === 'debt-payment')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const dayBalance = dayIncome - dayExpense;
            
            let reportContent = `
                <div class="space-y-4">
                    <div class="text-center border-b pb-4">
                        <h4 class="text-xl font-bold text-gray-800">${formatDate(dateStr)}</h4>
                        <div class="grid grid-cols-3 gap-4 mt-3">
                            <div class="bg-green-50 p-3 rounded">
                                <p class="text-sm text-green-800">Pemasukan</p>
                                <p class="text-lg font-bold text-green-600">${formatCurrency(dayIncome)}</p>
                            </div>
                            <div class="bg-red-50 p-3 rounded">
                                <p class="text-sm text-red-800">Pengeluaran</p>
                                <p class="text-lg font-bold text-red-600">${formatCurrency(dayExpense)}</p>
                            </div>
                            <div class="bg-blue-50 p-3 rounded">
                                <p class="text-sm text-blue-800">Saldo Bersih</p>
                                <p class="text-lg font-bold ${dayBalance >= 0 ? 'text-blue-600' : 'text-red-600'}">${formatCurrency(dayBalance)}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h5 class="font-semibold text-gray-800 mb-3">Detail Transaksi (${dayTransactions.length})</h5>
                        <div class="space-y-2 max-h-60 overflow-y-auto">
                            ${dayTransactions.map(transaction => {
                                const walletInfo = wallets[transaction.wallet];
                                const typeInfo = getTransactionTypeInfo(transaction);
                                
                                return `
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-8 h-8 rounded-full flex items-center justify-center ${typeInfo.bgColor}">
                                                <span class="text-sm">${typeInfo.icon}</span>
                                            </div>
                                            <div>
                                                <h6 class="font-medium text-gray-800 text-sm">${transaction.description}</h6>
                                                <p class="text-xs text-gray-600">${walletInfo.icon} ${walletInfo.name} â€¢ ${typeInfo.label}</p>
                                            </div>
                                        </div>
                                        <span class="font-semibold text-sm ${typeInfo.textColor}">
                                            ${typeInfo.sign}${formatCurrency(transaction.amount)}
                                        </span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('reportContent').innerHTML = reportContent;
            document.getElementById('reportModal').classList.remove('hidden');
            document.getElementById('reportModal').classList.add('flex');
        }

        function updateCurrentMonthSummary() {
            const walletFilter = document.getElementById('chartWalletFilter').value;
            
            // Get the period being displayed in the chart
            let filteredTransactions = transactions;
            if (walletFilter !== 'all') {
                filteredTransactions = filteredTransactions.filter(t => t.wallet === walletFilter);
            }
            
            // Group transactions by month
            const monthlyData = {};
            filteredTransactions.forEach(t => {
                const month = t.date.substring(0, 7); // YYYY-MM
                if (!monthlyData[month]) {
                    monthlyData[month] = { income: 0, expense: 0, transactions: [] };
                }
                if (t.type === 'income' || t.type === 'debt' || t.type === 'credit-payment') {
                    monthlyData[month].income += t.amount;
                } else if (t.type === 'expense' || t.type === 'credit' || t.type === 'debt-payment') {
                    monthlyData[month].expense += t.amount;
                }
                monthlyData[month].transactions.push(t);
            });

            // Get the months being displayed
            const allMonths = Object.keys(monthlyData).sort();
            const totalMonths = allMonths.length;
            const endIndex = totalMonths + (chartPeriodOffset * 6);
            const startIndex = Math.max(0, endIndex - 6);
            const displayedMonths = allMonths.slice(startIndex, endIndex);
            
            // Use the last month in the displayed period as "current month"
            let targetMonth;
            let monthlyTransactions = [];
            
            if (displayedMonths.length > 0) {
                targetMonth = displayedMonths[displayedMonths.length - 1];
                monthlyTransactions = monthlyData[targetMonth]?.transactions || [];
            } else {
                // Fallback to actual current month
                const now = new Date();
                targetMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                monthlyTransactions = filteredTransactions.filter(t => {
                    return t.date.substring(0, 7) === targetMonth;
                });
            }

            const monthlyIncome = monthlyTransactions
                .filter(t => t.type === 'income' || t.type === 'debt' || t.type === 'credit-payment')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const monthlyExpense = monthlyTransactions
                .filter(t => t.type === 'expense' || t.type === 'credit' || t.type === 'debt-payment')
                .reduce((sum, t) => sum + t.amount, 0);

            const netBalance = monthlyIncome - monthlyExpense;

            // Update current month display
            const [year, month] = targetMonth.split('-');
            const monthDate = new Date(year, month - 1);
            const monthName = monthDate.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
            
            document.getElementById('currentMonthName').textContent = monthName;
            document.getElementById('currentMonthIncome').textContent = formatCurrency(monthlyIncome);
            document.getElementById('currentMonthExpense').textContent = formatCurrency(monthlyExpense);
            document.getElementById('currentMonthNet').textContent = formatCurrency(netBalance);
            
            // Update net balance color
            const netElement = document.getElementById('currentMonthNet');
            if (netBalance >= 0) {
                netElement.className = 'text-lg font-bold text-green-600';
            } else {
                netElement.className = 'text-lg font-bold text-red-600';
            }

            // Update top categories
            updateTopCategories(monthlyTransactions);
        }

        function updateTopCategories(monthlyTransactions) {
            const categoryTotals = {};
            
            monthlyTransactions
                .filter(t => t.type === 'expense' && t.category)
                .forEach(t => {
                    if (!categoryTotals[t.category]) {
                        categoryTotals[t.category] = 0;
                    }
                    categoryTotals[t.category] += t.amount;
                });

            const sortedCategories = Object.entries(categoryTotals)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 3);

            const topCategoriesElement = document.getElementById('topCategories');
            
            if (sortedCategories.length === 0) {
                topCategoriesElement.innerHTML = '<p class="text-gray-500 text-sm">Belum ada data pengeluaran</p>';
                return;
            }

            topCategoriesElement.innerHTML = sortedCategories.map(([category, amount], index) => `
                <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                    <span class="text-sm">
                        ${index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : 'ğŸ¥‰'} 
                        ${getCategoryIcon(category)} ${getCategoryName(category)}
                    </span>
                    <span class="font-medium text-sm">${formatCurrency(amount)}</span>
                </div>
            `).join('');
        }

        function displayTransactions() {
            if (!currentWallet) return;
            
            const filterType = document.getElementById('filterType').value;
            const filterWallet = document.getElementById('filterWallet').value;
            const filterPeriod = document.getElementById('filterPeriod').value;
            
            let filteredTransactions = [...transactions];

            // Filter by wallet
            if (filterWallet !== 'all') {
                filteredTransactions = filteredTransactions.filter(t => t.wallet === filterWallet);
            }

            // Filter by type
            if (filterType !== 'all') {
                filteredTransactions = filteredTransactions.filter(t => t.type === filterType);
            }

            // Filter by period
            if (filterPeriod !== 'all') {
                const now = new Date();
                filteredTransactions = filteredTransactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    switch (filterPeriod) {
                        case 'today':
                            return transactionDate.toDateString() === now.toDateString();
                        case 'week':
                            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                            return transactionDate >= weekAgo;
                        case 'month':
                            return transactionDate.getMonth() === now.getMonth() && 
                                   transactionDate.getFullYear() === now.getFullYear();
                        default:
                            return true;
                    }
                });
            }

            const listElement = document.getElementById('transactionList');
            
            if (filteredTransactions.length === 0) {
                listElement.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <span class="text-4xl mb-4 block">ğŸ“</span>
                        <p>Tidak ada transaksi yang sesuai dengan filter</p>
                    </div>
                `;
                return;
            }

            listElement.innerHTML = filteredTransactions.map(transaction => {
                const walletInfo = wallets[transaction.wallet];
                const typeInfo = getTransactionTypeInfo(transaction);
                
                return `
                    <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors fade-in">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center ${typeInfo.bgColor}">
                                <span class="text-lg">${typeInfo.icon}</span>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-800 text-sm">${transaction.description}</h4>
                                <p class="text-xs text-gray-600">
                                    ${walletInfo.icon} ${walletInfo.name} â€¢ ${typeInfo.label} â€¢ ${formatDate(transaction.date)}
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="font-semibold text-sm ${typeInfo.textColor}">
                                ${typeInfo.sign}${formatCurrency(transaction.amount)}
                            </span>
                            <button onclick="deleteTransaction('${transaction.firebaseId || transaction.id}')" class="text-red-600 hover:text-red-800 p-1 text-xs">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getTransactionTypeInfo(transaction) {
            const types = {
                'income': { icon: 'ğŸ’°', label: 'Pemasukan', sign: '+', textColor: 'text-green-600', bgColor: 'bg-green-100' },
                'expense': { icon: 'ğŸ’¸', label: 'Pengeluaran', sign: '-', textColor: 'text-red-600', bgColor: 'bg-red-100' },
                'debt': { icon: 'ğŸ”´', label: `Hutang dari ${wallets[transaction.targetWallet]?.name}`, sign: '+', textColor: 'text-blue-600', bgColor: 'bg-blue-100' },
                'credit': { icon: 'ğŸŸ¢', label: `Piutang ke ${wallets[transaction.targetWallet]?.name}`, sign: '-', textColor: 'text-orange-600', bgColor: 'bg-orange-100' },
                'debt-payment': { icon: 'ğŸ’³', label: `Bayar hutang ke ${wallets[transaction.targetWallet]?.name}`, sign: '-', textColor: 'text-red-600', bgColor: 'bg-red-100' },
                'credit-payment': { icon: 'ğŸ’°', label: `Terima dari ${wallets[transaction.targetWallet]?.name}`, sign: '+', textColor: 'text-green-600', bgColor: 'bg-green-100' }
            };
            
            return types[transaction.type] || types['income'];
        }

        async function deleteTransaction(id) {
            if (confirm('Yakin ingin menghapus transaksi ini?')) {
                // Find transaction by either firebaseId or local id
                const transactionIndex = transactions.findIndex(t => t.firebaseId === id || t.id == id);
                
                if (transactionIndex !== -1) {
                    const transaction = transactions[transactionIndex];
                    
                    // Remove from local array
                    transactions.splice(transactionIndex, 1);
                    
                    // Delete from Firebase if it has firebaseId
                    if (transaction.firebaseId) {
                        await deleteFromFirebase(transaction.firebaseId);
                    }
                    
                    saveLocalData();
                    updateWalletBalances();
                    displayTransactions();
                    updateDebtSummary();
                    updateDailyChart();
                    updateCurrentMonthSummary();
                    showNotification('Transaksi berhasil dihapus!', 'success');
                }
            }
        }

        function showDebtReport() {
            const activeDebts = debts.filter(d => d.status === 'active');
            
            let reportContent = '<div class="space-y-6">';
            
            // Summary by wallet
            Object.keys(wallets).forEach(walletId => {
                const wallet = wallets[walletId];
                const walletDebts = activeDebts.filter(d => d.to === walletId);
                const walletCredits = activeDebts.filter(d => d.from === walletId);
                
                const totalDebt = walletDebts.reduce((sum, d) => sum + d.amount, 0);
                const totalCredit = walletCredits.reduce((sum, d) => sum + d.amount, 0);
                
                reportContent += `
                    <div class="border rounded-lg p-4">
                        <h4 class="font-semibold text-lg mb-3">${wallet.icon} ${wallet.name}</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-red-50 p-3 rounded">
                                <p class="text-sm text-red-800">Total Hutang</p>
                                <p class="text-xl font-bold text-red-600">${formatCurrency(totalDebt)}</p>
                            </div>
                            <div class="bg-green-50 p-3 rounded">
                                <p class="text-sm text-green-800">Total Piutang</p>
                                <p class="text-xl font-bold text-green-600">${formatCurrency(totalCredit)}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Detailed debt list
            if (activeDebts.length > 0) {
                reportContent += `
                    <div>
                        <h4 class="font-semibold text-lg mb-3">Detail Hutang-Piutang Aktif</h4>
                        <div class="space-y-2">
                            ${activeDebts.map(debt => `
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                                    <span>${wallets[debt.to].icon} ${wallets[debt.to].name} berhutang ke ${wallets[debt.from].icon} ${wallets[debt.from].name}</span>
                                    <span class="font-medium">${formatCurrency(debt.amount)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            reportContent += '</div>';
            
            document.getElementById('reportContent').innerHTML = reportContent;
            document.getElementById('reportModal').classList.remove('hidden');
            document.getElementById('reportModal').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('reportModal').classList.add('hidden');
            document.getElementById('reportModal').classList.remove('flex');
        }

        function exportData() {
            const data = {
                transactions: transactions,
                debts: debts,
                exportDate: new Date().toISOString()
            };
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `keuangan-multi-dompet-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            showNotification('Data berhasil diexport!', 'success');
        }

        function clearAllData() {
            if (confirm('Yakin ingin menghapus SEMUA data? Tindakan ini tidak dapat dibatalkan!')) {
                transactions = [];
                debts = [];
                localStorage.removeItem('transactions');
                localStorage.removeItem('debts');
                updateWalletBalances();
                displayTransactions();
                updateDebtSummary();
                updateDailyChart();
                updateCurrentMonthSummary();
                showNotification('Semua data berhasil dihapus!', 'success');
            }
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            let bgColor = 'bg-red-500';
            if (type === 'success') bgColor = 'bg-green-500';
            if (type === 'info') bgColor = 'bg-blue-500';
            
            notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-40 ${bgColor} fade-in`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Filter event listeners
        document.getElementById('filterType').addEventListener('change', displayTransactions);
        document.getElementById('filterWallet').addEventListener('change', displayTransactions);
        document.getElementById('filterPeriod').addEventListener('change', displayTransactions);
        document.getElementById('chartWalletFilter').addEventListener('change', function() {
            updateDailyChart();
            updateCurrentMonthSummary();
        });

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function formatCurrencyShort(amount) {
            if (Math.abs(amount) >= 1000000) {
                return (amount / 1000000).toFixed(1) + 'M';
            } else if (Math.abs(amount) >= 1000) {
                return (amount / 1000).toFixed(0) + 'K';
            }
            return amount.toLocaleString('id-ID');
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
        }

        function formatMonth(monthString) {
            const [year, month] = monthString.split('-');
            return new Date(year, month - 1).toLocaleDateString('id-ID', {
                month: 'short',
                year: '2-digit'
            });
        }

        function getCategoryIcon(category) {
            const icons = {
                'penjualan': 'ğŸ›’',
                'investasi': 'ğŸ“ˆ',
                'lainnya-masuk': 'ğŸ’¼',
                'bahan-baku': 'ğŸ“¦',
                'operasional': 'âš™ï¸',
                'marketing': 'ğŸ“¢',
                'sewa': 'ğŸ¢',
                'tabungan': 'ğŸ’°',
                'lainnya-keluar': 'ğŸ“‹'
            };
            return icons[category] || 'ğŸ’°';
        }

        function getCategoryName(category) {
            const names = {
                'penjualan': 'Penjualan',
                'investasi': 'Investasi',
                'lainnya-masuk': 'Lainnya',
                'bahan-baku': 'Bahan Baku',
                'operasional': 'Operasional',
                'marketing': 'Marketing',
                'sewa': 'Sewa',
                'tabungan': 'Tabungan',
                'lainnya-keluar': 'Lainnya'
            };
            return names[category] || category;
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97b79a2a276944c3',t:'MTc1NzI2Mjc0Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
